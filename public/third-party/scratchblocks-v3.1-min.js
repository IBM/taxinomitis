/*
 * scratchblocks
 * http://scratchblocks.github.io/
 *
 * Copyright 2013-2016, Tim Radvan
 * @license MIT
 * http://opensource.org/licenses/MIT
 */
(function(e){if(typeof module!=="undefined"&&module.exports){module.exports=e}else{var t=function(){return document.createElement("canvas")};var n=window.scratchblocks=e(window,t);document.head.appendChild(n.makeStyle())}})(function(e,t){"use strict";var n=e.document;var r=e.XMLSerializer;var i=e.DOMParser;function s(e,t){if(!e)throw"Assertion failed! "+(t||"")}function o(e){return e&&e.constructor===Array}function a(e){return!!e}function l(e,t){e=e||{};t=t||{};for(var n in e){if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n)){t[n]=e[n]}}return t}function c(e){return e.split("\n").map(function(e){return"  "+e}).join("\n")}var h=["motion","looks","sound","pen","variables","list","events","control","sensing","operators","custom","custom-arg","extension","grey","obsolete"];var u=["hat","cap","stack","boolean","reporter","ring"];var f=["ar","fa","he"];var p=[["move %n steps"," ",1,"forward:"],["turn @turnRight %n degrees"," ",1,"turnRight:"],["turn @turnLeft %n degrees"," ",1,"turnLeft:"],["point in direction %d.direction"," ",1,"heading:"],["point towards %m.spriteOrMouse"," ",1,"pointTowards:"],["go to x:%n y:%n"," ",1,"gotoX:y:"],["go to %m.location"," ",1,"gotoSpriteOrMouse:"],["glide %n secs to x:%n y:%n"," ",1,"glideSecs:toX:y:elapsed:from:"],["change x by %n"," ",1,"changeXposBy:"],["set x to %n"," ",1,"xpos:"],["change y by %n"," ",1,"changeYposBy:"],["set y to %n"," ",1,"ypos:"],["set rotation style %m.rotationStyle"," ",1,"setRotationStyle"],["say %s for %n secs"," ",2,"say:duration:elapsed:from:"],["say %s"," ",2,"say:"],["think %s for %n secs"," ",2,"think:duration:elapsed:from:"],["think %s"," ",2,"think:"],["show"," ",2,"show"],["hide"," ",2,"hide"],["switch costume to %m.costume"," ",2,"lookLike:"],["next costume"," ",2,"nextCostume"],["next backdrop"," ",102,"nextScene"],["switch backdrop to %m.backdrop"," ",2,"startScene"],["switch backdrop to %m.backdrop and wait"," ",102,"startSceneAndWait"],["change %m.effect effect by %n"," ",2,"changeGraphicEffect:by:"],["set %m.effect effect to %n"," ",2,"setGraphicEffect:to:"],["clear graphic effects"," ",2,"filterReset"],["change size by %n"," ",2,"changeSizeBy:"],["set size to %n%"," ",2,"setSizeTo:"],["go to front"," ",2,"comeToFront"],["go back %n layers"," ",2,"goBackByLayers:"],["play sound %m.sound"," ",3,"playSound:"],["play sound %m.sound until done"," ",3,"doPlaySoundAndWait"],["stop all sounds"," ",3,"stopAllSounds"],["play drum %d.drum for %n beats"," ",3,"playDrum"],["rest for %n beats"," ",3,"rest:elapsed:from:"],["play note %d.note for %n beats"," ",3,"noteOn:duration:elapsed:from:"],["set instrument to %d.instrument"," ",3,"instrument:"],["change volume by %n"," ",3,"changeVolumeBy:"],["set volume to %n%"," ",3,"setVolumeTo:"],["change tempo by %n"," ",3,"changeTempoBy:"],["set tempo to %n bpm"," ",3,"setTempoTo:"],["clear"," ",4,"clearPenTrails"],["stamp"," ",4,"stampCostume"],["pen down"," ",4,"putPenDown"],["pen up"," ",4,"putPenUp"],["set pen color to %c"," ",4,"penColor:"],["change pen color by %n"," ",4,"changePenHueBy:"],["set pen color to %n"," ",4,"setPenHueTo:"],["change pen shade by %n"," ",4,"changePenShadeBy:"],["set pen shade to %n"," ",4,"setPenShadeTo:"],["change pen size by %n"," ",4,"changePenSizeBy:"],["set pen size to %n"," ",4,"penSize:"],["when @greenFlag clicked","h",5,"whenGreenFlag"],["when %m.key key pressed","h",5,"whenKeyPressed"],["when this sprite clicked","h",5,"whenClicked"],["when backdrop switches to %m.backdrop","h",5,"whenSceneStarts"],["when %m.triggerSensor > %n","h",5,"whenSensorGreaterThan"],["when I receive %m.broadcast","h",5,"whenIReceive"],["broadcast %m.broadcast"," ",5,"broadcast:"],["broadcast %m.broadcast and wait"," ",5,"doBroadcastAndWait"],["wait %n secs"," ",6,"wait:elapsed:from:"],["repeat %n","c",6,"doRepeat"],["forever","cf",6,"doForever"],["if %b then","c",6,"doIf"],["if %b then","e",6,"doIfElse"],["wait until %b"," ",6,"doWaitUntil"],["repeat until %b","c",6,"doUntil"],["stop %m.stop","f",6,"stopScripts"],["when I start as a clone","h",6,"whenCloned"],["create clone of %m.spriteOnly"," ",6,"createCloneOf"],["delete this clone","f",6,"deleteClone"],["ask %s and wait"," ",7,"doAsk"],["turn video %m.videoState"," ",7,"setVideoState"],["set video transparency to %n%"," ",7,"setVideoTransparency"],["reset timer"," ",7,"timerReset"],["set %m.var to %s"," ",9,"setVar:to:"],["change %m.var by %n"," ",9,"changeVar:by:"],["show variable %m.var"," ",9,"showVariable:"],["hide variable %m.var"," ",9,"hideVariable:"],["add %s to %m.list"," ",12,"append:toList:"],["delete %d.listDeleteItem of %m.list"," ",12,"deleteLine:ofList:"],["if on edge, bounce"," ",1,"bounceOffEdge"],["insert %s at %d.listItem of %m.list"," ",12,"insert:at:ofList:"],["replace item %d.listItem of %m.list with %s"," ",12,"setLine:ofList:to:"],["show list %m.list"," ",12,"showList:"],["hide list %m.list"," ",12,"hideList:"],["x position","r",1,"xpos"],["y position","r",1,"ypos"],["direction","r",1,"heading"],["costume #","r",2,"costumeIndex"],["size","r",2,"scale"],["backdrop name","r",102,"sceneName"],["backdrop #","r",102,"backgroundIndex"],["volume","r",3,"volume"],["tempo","r",3,"tempo"],["touching %m.touching?","b",7,"touching:"],["touching color %c?","b",7,"touchingColor:"],["color %c is touching %c?","b",7,"color:sees:"],["distance to %m.spriteOrMouse","r",7,"distanceTo:"],["answer","r",7,"answer"],["key %m.key pressed?","b",7,"keyPressed:"],["mouse down?","b",7,"mousePressed"],["mouse x","r",7,"mouseX"],["mouse y","r",7,"mouseY"],["loudness","r",7,"soundLevel"],["video %m.videoMotionType on %m.stageOrThis","r",7,"senseVideoMotion"],["timer","r",7,"timer"],["%m.attribute of %m.spriteOrStage","r",7,"getAttribute:of:"],["current %m.timeAndDate","r",7,"timeAndDate"],["days since 2000","r",7,"timestamp"],["username","r",7,"getUserName"],["%n + %n","r",8,"+"],["%n - %n","r",8,"-"],["%n * %n","r",8,"*"],["%n / %n","r",8,"/"],["pick random %n to %n","r",8,"randomFrom:to:"],["%s < %s","b",8,"<"],["%s = %s","b",8,"="],["%s > %s","b",8,">"],["%b and %b","b",8,"&"],["%b or %b","b",8,"|"],["not %b","b",8,"not"],["join %s %s","r",8,"concatenate:with:"],["letter %n of %s","r",8,"letter:of:"],["length of %s","r",8,"stringLength:"],["%n mod %n","r",8,"%"],["round %n","r",8,"rounded"],["%m.mathOp of %n","r",8,"computeFunction:of:"],["item %d.listItem of %m.list","r",12,"getLine:ofList:"],["length of %m.list","r",12,"lineCountOfList:"],["%m.list contains %s?","b",12,"list:contains:"],["when %m.booleanSensor","h",20,""],["when %m.sensor %m.lessMore %n","h",20,""],["sensor %m.booleanSensor?","b",20,""],["%m.sensor sensor value","r",20,""],["turn %m.motor on for %n secs"," ",20,""],["turn %m.motor on"," ",20,""],["turn %m.motor off"," ",20,""],["set %m.motor power to %n"," ",20,""],["set %m.motor2 direction to %m.motorDirection"," ",20,""],["when distance %m.lessMore %n","h",20,""],["when tilt %m.eNe %n","h",20,""],["distance","r",20,""],["tilt","r",20,""],["turn %m.motor on for %n seconds"," ",20,""],["set light color to %n"," ",20,""],["play note %n for %n seconds"," ",20,""],["when tilted","h",20,""],["tilt %m.xxx","r",20,""],["else","else",6,""],["end","end",6,""],[". . ."," ",42,""],["%n @addInput","ring",42,""],["user id","r",0,""],["if %b","c",0,"doIf"],["if %b","e",0,"doIfElse"],["forever if %b","cf",0,"doForeverIf"],["stop script","f",0,"doReturn"],["stop all","f",0,"stopAll"],["switch to costume %m.costume"," ",0,"lookLike:"],["next background"," ",0,"nextScene"],["switch to background %m.backdrop"," ",0,"startScene"],["background #","r",0,"backgroundIndex"],["loud?","b",0,"isLoud"]];var d={0:"obsolete",1:"motion",2:"looks",3:"sound",4:"pen",5:"events",6:"control",7:"sensing",8:"operators",9:"variables",10:"custom",11:"parameter",12:"list",20:"extension",42:"grey"};var v={" ":"stack",b:"boolean",c:"c-block",e:"if-block",f:"cap",h:"hat",r:"reporter",cf:"c-block cap",else:"celse",end:"cend",ring:"ring"};var g=/(%[a-zA-Z](?:\.[a-zA-Z0-9]+)?)/;var m=new RegExp(g.source,"g");var b=/(@[a-zA-Z]+)/;var w=new RegExp([g.source,"|",b.source,"| +"].join(""),"g");var y=/^#(?:[0-9a-fA-F]{3}){1,2}?$/;function k(e){var t=e.split(w).filter(a);return{spec:e,parts:t,inputs:t.filter(function(e){return g.test(e)}),hash:L(e)}}function L(e){return S(e.replace(m," _ "))}function S(e){return e.replace(/_/g," _ ").replace(/ +/g," ").replace(/[,%?:]/g,"").replace(/ß/g,"ss").replace(/ä/g,"a").replace(/ö/g,"o").replace(/ü/g,"u").replace(". . .","...").replace(/^…$/,"...").trim().toLowerCase()}var x={};var I={};var O=p.map(function(e){var t=l(k(e[0]),{shape:v[e[1]],category:d[e[2]%100],selector:e[3],hasLoopArrow:["doRepeat","doUntil","doForever"].indexOf(e[3])>-1});if(t.selector){if(!x[t.selector])x[t.selector]=t}return I[t.spec]=t});var C={"@greenFlag":"⚑","@turnRight":"↻","@turnLeft":"↺","@addInput":"▸","@delInput":"◂"};var A={};function M(e,t){var n=t.blocksByHash={};Object.keys(t.commands).forEach(function(e){var r=t.commands[e];var i=I[e];var s=L(r);n[s]=i;var o=b.exec(e);if(o){var a=o[0];var l=s.replace(a,C[a]);n[l]=i}});t.nativeAliases={};Object.keys(t.aliases).forEach(function(e){var r=t.aliases[e];var i=I[r];var s=L(e);n[s]=i;t.nativeAliases[r]=e});t.nativeDropdowns={};Object.keys(t.dropdowns).forEach(function(e){var n=t.dropdowns[e];t.nativeDropdowns[n]=e});t.code=e;A[e]=t}function B(e){Object.keys(e).forEach(function(t){M(t,e[t])})}var R={aliases:{"turn left %n degrees":"turn @turnLeft %n degrees","turn ccw %n degrees":"turn @turnLeft %n degrees","turn right %n degrees":"turn @turnRight %n degrees","turn cw %n degrees":"turn @turnRight %n degrees","when gf clicked":"when @greenFlag clicked","when flag clicked":"when @greenFlag clicked","when green flag clicked":"when @greenFlag clicked"},define:["define"],ignorelt:["when distance"],math:["abs","floor","ceiling","sqrt","sin","cos","tan","asin","acos","atan","ln","log","e ^","10 ^"],osis:["other scripts in sprite","other scripts in stage"],dropdowns:{},commands:{}};O.forEach(function(e){R.commands[e.spec]=e.spec}),B({en:R});function j(e,t,n){var r=function(r,i,s){return x[n(i,s)?e:t]};x[e].specialCase=x[t].specialCase=r}j("computeFunction:of:","getAttribute:of:",function(e,t){var n=e[0];if(!n.isInput)return;var r=n.value;return t.math.indexOf(r)>-1});j("lineCountOfList:","stringLength:",function(e,t){var n=e[e.length-1];if(!n.isInput)return;return n.shape==="dropdown"});j("penColor:","setPenHueTo:",function(e,t){var n=e[e.length-1];return n.isInput&&n.isColor||n.isBlock});x["stopScripts"].specialCase=function(e,t,n){var r=t[t.length-1];if(!r.isInput)return;var i=r.value;if(n.osis.indexOf(i)>-1){return l(x["stopScripts"],{shape:"stack"})}};function E(e,t,n,r){for(var i=0;i<r.length;i++){var s=r[i];if(s.blocksByHash.hasOwnProperty(e)){var o=s.blocksByHash[e];if(t.shape==="reporter"&&o.shape!=="reporter")continue;if(t.shape==="boolean"&&o.shape!=="boolean")continue;if(o.specialCase){o=o.specialCase(t,n,s)||o}return{type:o,lang:s}}}}function D(e,t){for(var n=0;n<t.length;n++){var r=t[n];if(r.nativeDropdowns.hasOwnProperty(e)){var i=r.nativeDropdowns[e];return i}}}function N(e,t){for(var n=0;n<t.length;n++){var r=t[n];if(y.test(r)){e.color=r;e.category="";e.categoryIsDefault=false}else if(h.indexOf(r)>-1){e.category=r;e.categoryIsDefault=false}else if(u.indexOf(r)>-1){e.shape=r}else if(r==="loop"){e.hasLoopArrow=true}}}function P(e,t,n){var r=[];if(o(t[t.length-1])){r=t.pop()}var i=[];for(var s=0;s<t.length;s++){var a=t[s];if(a.isLabel){i.push(a.value)}else if(a.isIcon){i.push("@"+a.name)}else{i.push("_")}}var l=e.hash=S(i.join(" "));var c=E(l,e,t,n);if(c){var h=c.lang;var u=c.type;e.language=h;e.isRTL=f.indexOf(h.code)>-1;if(u.shape==="ring"?e.shape==="reporter":e.shape==="stack"){e.shape=u.shape}e.category=u.category;e.categoryIsDefault=false;if(u.selector)e.selector=u.selector;e.hasLoopArrow=u.hasLoopArrow;if(u.spec===". . ."){t=[new Fe(". . .")]}}N(e,r);if(e.hasLoopArrow){t.push(new Te("loopArrow"))}var p=new ze(e,t);if(u&&b.test(u.spec)){p.translate(h,true)}return p}function F(e,t){var n=e[0];var r=0;function i(){n=e[++r]}function o(){return e[r+1]}function a(){for(var t=r+1;t<e.length;t++){if(e[t]!==" ")return e[t]}}var l;var c=[];t.map(function(e){c=c.concat(e.define)});function h(e){return c.indexOf(e)>-1}function u(e,n){var r=!!n.filter(function(e){return!e.isLabel}).length;var i={shape:e,category:e==="define-hat"?"custom":e==="reporter"&&!r?"variables":"obsolete",categoryIsDefault:true,hasLoopArrow:false};return P(i,n,t)}function f(e,n){var r=D(n,t)||n;return new Ve(e,n,r)}function p(e){var t=[];var r;while(n&&n!=="\n"){if(n==="<"||n===">"&&e===">"){var s=t[t.length-1];var l=a();if(s&&!s.isLabel&&(l==="["||l==="("||l==="<"||l==="{")){r=null;t.push(new Fe(n));i();continue}}if(n===e)break;if(n==="/"&&o()==="/"&&!e)break;switch(n){case"[":r=null;t.push(d());break;case"(":r=null;t.push(g());break;case"<":r=null;t.push(m());break;case"{":r=null;t.push(b());break;case" ":case"\t":i();if(r&&h(r.value)){t.push(S());return t}r=null;break;case"◂":case"▸":t.push(w());r=null;break;case"@":i();var c="";while(n&&/[a-zA-Z]/.test(n)){c+=n;i()}if(c==="cloud"){t.push(new Fe("☁"))}else{t.push(Te.icons.hasOwnProperty(c)?new Te(c):new Fe("@"+c))}r=null;break;case"\\":i();case":":if(n===":"&&o()===":"){t.push(k(e));return t}default:if(!r)t.push(r=new Fe(""));r.value+=n;i()}}return t}function d(){i();var e="";var t=false;while(n&&n!=="]"&&n!=="\n"){if(n==="\\"){i();if(n==="v")t=true;if(!n)break}else{t=false}e+=n;i()}if(n==="]")i();if(y.test(e)){return new Ve("color",e)}return!t&&/ v$/.test(e)?f("dropdown",e.slice(0,e.length-2)):new Ve("string",e)}function v(e){var t=p(e);if(n&&n==="\n"){l=true;i()}if(t.length===0)return;var r=t[0];if(r&&r.isLabel&&h(r.value)){if(t.length<2){t.push(u("outline",[]))}return u("define-hat",t)}if(t.length===1){var s=t[0];if(s.isBlock&&(s.isReporter||s.isBoolean||s.isRing)){return s}}return u("stack",t)}function g(){i();if(n===" "){i();if(n==="v"&&o()===")"){i();i();return new Ve("number-dropdown","")}}var e=p(")");if(n&&n===")")i();if(e.length===0){return new Ve("number","")}if(e.length===1&&e[0].isLabel){var t=e[0].value;if(/^[0-9e.-]*$/.test(t)){return new Ve("number",t)}}for(var r=0;r<e.length;r++){if(!e[r].isLabel){break}}if(r===e.length){var s=e[r-1];if(r>1&&s.value==="v"){e.pop();var t=e.map(function(e){return e.value}).join(" ");return f("number-dropdown",t)}}var a=u("reporter",e);if(a.info.shape==="ring"){var l=a.children[0];if(l&&l.isInput&&l.shape==="number"&&l.value===""){a.children[0]=new Ve("reporter")}else if(l&&l.isScript&&l.isEmpty||l&&l.isBlock&&!l.children.length){a.children[0]=new Ve("stack")}}return a}function m(){i();var e=p(">");if(n&&n===">")i();if(e.length===0){return new Ve("boolean")}return u("boolean",e)}function b(){i();l=false;var e=function(){while(n&&n!=="}"){var e=v("}");if(e)return e}};var t=T(e);var r=[];t.forEach(function(e){r=r.concat(e.blocks)});if(n==="}")i();if(!l){s(r.length<=1);return r.length?r[0]:u("stack",[])}return new Je(r)}function w(){var e=n;i();switch(e){case"▸":return new Te("addInput");case"◂":return new Te("delInput")}}function k(e){i();i();var t=[];var r="";while(n&&n!=="\n"&&n!==e){if(n===" "){if(r){t.push(r);r=""}}else if(n==="/"&&o()==="/"){break}else{r+=n}i()}if(r)t.push(r);return t}function L(e){i();i();var t="";while(n&&n!=="\n"&&n!==e){t+=n;i()}if(n&&n==="\n")i();return new _e(t,true)}function S(){var e=[];function r(r,o){s=null;i();var a=p(o);if(n===o)i();e.push(P({shape:r==="boolean"?"boolean":"reporter",argument:r,category:"custom-arg"},a,t))}var s;while(n&&n!=="\n"){switch(n){case"(":r("number",")");break;case"[":r("string","]");break;case"<":r("boolean",">");break;case" ":i();s=null;break;case"\\":i();case":":if(n===":"&&o()===":"){e.push(k());break}default:if(!s)e.push(s=new Fe(""));s.value+=n;i()}}return u("outline",e)}function x(){var e=v();if(n==="/"&&o()==="/"){var t=L();t.hasBlock=e&&e.children.length;if(!t.hasBlock){return t}e.comment=t}return e}return function(){if(!n)return undefined;var e=x();return e||"NL"}}function T(e){var t=e();function n(){t=e()}function r(){while(t==="NL")n();var e=[];while(t){var r=[];while(t&&t!=="NL"){var s=i();if(s.isElse||s.isEnd){s=new ze(l(s.info,{shape:"stack"}),s.children)}if(s.isHat){if(r.length)e.push(new Je(r));r=[s]}else if(s.isFinal){r.push(s);break}else if(s.isCommand){r.push(s)}else{if(r.length)e.push(new Je(r));e.push(new Je([s]));r=[];break}}if(r.length)e.push(new Je(r));while(t==="NL")n()}return e}function i(){var e=t;n();if(e.hasScript){while(true){var r=s();e.children.push(new Je(r));if(t&&t.isElse){for(var i=0;i<t.children.length;i++){e.children.push(t.children[i])}n();continue}if(t&&t.isEnd){n()}break}}return e}function s(){var e=[];while(t){if(t==="NL"){n();continue}if(!t.isCommand){return e}e.push(i())}return e}return r()}function V(e,t){if(e.isScript){e.blocks.forEach(function(e){V(e,t)})}else if(e.isBlock){t(e);e.children.forEach(function(e){V(e,t)})}}var z={"append:toList:":1,"deleteLine:ofList:":1,"insert:at:ofList:":2,"setLine:ofList:to:":1,"showList:":0,"hideList:":0};function _(e){var t=[];for(var n=0;n<e.children.length;n++){var r=e.children[n];if(!r.isLabel)return;t.push(r.value)}return t.join(" ")}function J(e){var t={};var n={};e.forEach(function(e){var r={};V(e,function(e){if(e.info.shape==="define-hat"){var i=e.children[1];if(!i)return;var s=[];var o=[];for(var a=0;a<i.children.length;a++){var l=i.children[a];if(l.isLabel){o.push(l.value)}else if(l.isBlock){if(!l.info.argument)return;o.push({number:"%n",string:"%s",boolean:"%b"}[l.info.argument]);var c=_(l);s.push(c);r[c]=true}}var h=o.join(" ");var u=L(h);var f=t[u]={spec:h,names:s};e.info.selector="procDef";e.info.call=f.spec;e.info.names=f.names;e.info.category="custom"}else if(e.info.selector==="doIfElse"){var p=e.children[e.children.length-2];e.info.selector=p&&p.isLabel&&p.value==="else"?"doIfElse":"doIf"}else if(e.info.categoryIsDefault&&(e.isReporter||e.isBoolean)){var c=_(e);if(r[c]){e.info.category="custom-arg";e.info.categoryIsDefault=false;e.info.selector="getParam"}}else if(z.hasOwnProperty(e.info.selector)){var d=z[e.info.selector];var v=e.children.filter(function(e){return!e.isLabel});var g=v[d];if(g&&g.isInput){n[g.value]=true}}})});e.forEach(function(e){V(e,function(e){if(e.info.categoryIsDefault&&e.info.category==="obsolete"){var r=t[e.info.hash];if(r){e.info.selector="call";e.info.call=r.spec;e.info.names=r.names;e.info.category="custom"}}else if(e.isReporter){var i=_(e);if(!i)return;if(e.info.category==="variables"&&n[i]&&e.info.categoryIsDefault){e.info.category="list";e.info.categoryIsDefault=false}if(e.info.category==="list"){e.info.selector="contentsOfList:"}else if(e.info.category==="variables"){e.info.selector="readVariable"}}})})}function Z(e,t){var t=l({inline:false,languages:["en"]},t);e=e.replace(/&lt;/g,"<");e=e.replace(/&gt;/g,">");if(t.inline){e=e.replace(/\n/g," ")}var n=t.languages.map(function(e){return A[e]});var r=F(e,n);var i=T(r);J(i);return new Ze(i)}var G=(new i).parseFromString("<xml></xml>","application/xml");function H(e){return G.createCDATASection(e)}function U(e,t){var r=n.createElementNS("http://www.w3.org/2000/svg",e);return W(r,t)}var Q={textContent:true};function W(e,t){for(var n in t){var r=""+t[n];if(Q[n]){e[n]=r}else if(/^xlink:/.test(n)){e.setAttributeNS("http://www.w3.org/1999/xlink",n.slice(6),r)}else if(t[n]!==null&&t.hasOwnProperty(n)){e.setAttributeNS(null,n,r)}}return e}function $(e,t){for(var n=0;n<t.length;n++){e.appendChild(t[n])}return e}function X(e){return $(U("g"),e)}function q(e,t){return U("svg",{version:"1.1",width:e,height:t})}function Y(e){return U("polygon",l(e,{points:e.points.join(" ")}))}function K(e){return U("path",l(e,{path:null,d:e.path.join(" ")}))}function ee(e,t,n,r){var i=U("text",l(r,{x:e,y:t,textContent:n}));return i}function te(e){return U("use",{"xlink:href":e})}function ne(e,t,n){W(n,{transform:["translate(",e," ",t,")"].join("")});return n}function re(e,t,n){var r=true;var i=n.split(" ");var o=[];for(var a=0;a<i.length;a++){var l=i[a];if(l==="A"){var c=a+5;o.push("A");while(a<c){o.push(i[++a])}continue}else if(/[A-Za-z]/.test(l)){s(r)}else{l=+l;l+=r?e:t;r=!r}o.push(l)}return o.join(" ")}function ie(e,t,n){return U("rect",l(n,{x:0,y:0,width:e,height:t}))}function se(e,t,n,r,i,s){var o=r-t;return["L",e,t,"A",i,s,0,0,1,n,r].join(" ")}function oe(e,t,n,r,i,s){var o=r-t;return["L",e,t,"A",i,s,0,0,0,n,r].join(" ")}function ae(e,t){var n=t/2;return["M",n,0,se(e-n,0,e-n,t,n,n),se(n,t,n,0,n,n),"Z"]}function le(e,t,n){return K(l(n,{path:ae(e,t)}))}function ce(e,t){var n=t/2;return["M",n,0,"L",e-n,0,e,n,"L",e,n,e-n,t,"L",n,t,0,n,"L",0,n,n,0,"Z"]}function he(e,t,n){return K(l(n,{path:ce(e,t)}))}function ue(e){return["M",0,3,"L",3,0,"L",13,0,"L",16,3,"L",24,3,"L",27,0,"L",e-3,0,"L",e,3].join(" ")}function fe(e){return["M",0,3,"L",3,0,"L",7,0,"L",10,3,"L",16,3,"L",19,0,"L",e-3,0,"L",e,3].join(" ")}function pe(e,t,n,r){if(typeof r==="undefined"){r=0}var i=["L",e,t-3,"L",e-3,t];if(n){i=i.concat(["L",r+27,t,"L",r+24,t+3,"L",r+16,t+3,"L",r+13,t])}if(r>0){i=i.concat(["L",r+2,t,"L",r,t+2])}else{i=i.concat(["L",r+3,t,"L",0,t-3])}return i.join(" ")}function de(e,t){return["L",15,t-2,"L",15+2,t,"L",e-3,t,"L",e,t+3].join(" ")}function ve(e,t,n){return K(l(n,{path:[ue(e),pe(e,t,true,0),"Z"]}))}function ge(e,t){return[ue(e),pe(e,t,false,0),"Z"]}function me(e,t){return[fe(e),pe(e,t,false,0),"Z"]}function be(e,t,n){return K(l(n,{path:ge(e,t)}))}function we(e,t,n){return K(l(n,{path:["M",0,12,se(0,12,80,10,80,80),"L",e-3,10,"L",e,10+3,pe(e,t,true),"Z"]}))}function ye(e,t,n,r,i){var i=i||.42;var s=(e+n)/2;var o=(t+r)/2;var a=Math.round(s+i*(r-t));var l=Math.round(o-i*(n-e));return[a,l,n,r].join(" ")}function ke(e,t,n,r){var n=Math.min(.2,35/e);return K(l(r,{path:["M",0,15,"Q",ye(0,15,e,15,n),pe(e,t,true),"M",-1,13,"Q",ye(-1,13,e+1,13,n),"Q",ye(e+1,13,e,16,.6),"Q",ye(e,16,0,16,-n),"Q",ye(0,16,-1,13,.6),"Z"]}))}function Le(e,t,n){return K({path:["M",-1,13,"Q",ye(-1,13,e+1,13,n),"Q",ye(e+1,13,e,16,.6),"Q",ye(e,16,0,16,-n),"Q",ye(0,16,-1,13,.6),"Z"],class:"sb-define-hat-cap"})}function Se(e,t,n){var r=52;var i=t-r;var s=Math.min(.2,35/e);return ne(0,i,X([ke(e,r,s,n),Le(e,r,s)]))}function xe(e,t,n,r,i){var s=r[0].height;var o=[ue(e),pe(e,s,true,15)];for(var a=1;a<r.length;a+=2){var c=a+2===r.length;s+=r[a].height-3;o.push(de(e,s));var h=!(c&&n);var u=c?0:15;s+=r[a+1].height+3;o.push(pe(e,s,h,u))}return K(l(i,{path:o}))}function Ie(e,t,n,r,i,s,o){var a=8;var c=s==="reporter"?ae:s==="boolean"?ce:r<40?me:ge;return K(l(o,{path:["M",a,0,oe(a,0,0,a,a,a),oe(0,t-a,a,t,a,a),oe(e-a,t,e,t-a,a,a),oe(e,a,e-a,0,a,a),"Z",re(4,n||4,c(r,i).join(" "))],"fill-rule":"even-odd"}))}function Oe(e,t,n){var r=6;return K(l(n,{class:"sb-comment",path:["M",r,0,se(e-r,0,e,r,r,r),se(e,t-r,e-r,t,r,r),se(r,t,0,t-r,r,r),se(0,r,r,0,r,r),"Z"]}))}function Ce(e,t){return ne(-e,9,ie(e,2,l(t,{class:"sb-comment-line"})))}var Ae=".sb-label{font-family:Lucida Grande,Verdana,Arial,DejaVu Sans,sans-serif;font-weight:700;fill:#fff;font-size:10px;word-spacing:+1px}.sb-obsolete{fill:#d42828}.sb-motion{fill:#4a6cd4}.sb-looks{fill:#8a55d7}.sb-sound{fill:#bb42c3}.sb-pen{fill:#0e9a6c}.sb-events{fill:#c88330}.sb-control{fill:#e1a91a}.sb-sensing{fill:#2ca5e2}.sb-operators{fill:#5cb712}.sb-variables{fill:#ee7d16}.sb-list{fill:#cc5b22}.sb-custom{fill:#632d99}.sb-custom-arg{fill:#5947b1}.sb-extension{fill:#4b4a60}.sb-grey{fill:#969696}.sb-bevel{filter:url(#bevelFilter)}.sb-input{filter:url(#inputBevelFilter)}.sb-input-number,.sb-input-number-dropdown,.sb-input-string{fill:#fff}.sb-literal-dropdown,.sb-literal-number,.sb-literal-number-dropdown,.sb-literal-string{font-weight:400;font-size:9px;word-spacing:0}.sb-literal-number,.sb-literal-number-dropdown,.sb-literal-string{fill:#000}.sb-darker{filter:url(#inputDarkFilter)}.sb-outline{stroke:#fff;stroke-opacity:.2;stroke-width:2;fill:none}.sb-define-hat-cap{stroke:#632d99;stroke-width:1;fill:#8e2ec2}.sb-comment{fill:#ffffa5;stroke:#d0d1d2;stroke-width:1}.sb-comment-line{fill:#ffff80}.sb-comment-label{font-family:Helevetica,Arial,DejaVu Sans,sans-serif;font-weight:700;fill:#5c5d5f;word-spacing:0;font-size:12px}";var Me="Lucida Grande, Verdana, Arial, DejaVu Sans, sans-serif";function Be(){var e=U("style");e.appendChild(H(Ae));return e}function Re(){return[U("path",{d:"M1.504 21L0 19.493 4.567 0h1.948l-.5 2.418s1.002-.502 3.006 0c2.006.503 3.008 2.01 6.517 2.01 3.508 0 4.463-.545 4.463-.545l-.823 9.892s-2.137 1.005-5.144.696c-3.007-.307-3.007-2.007-6.014-2.51-3.008-.502-4.512.503-4.512.503L1.504 21z",fill:"#3f8d15",id:"greenFlag"}),U("path",{d:"M6.724 0C3.01 0 0 2.91 0 6.5c0 2.316 1.253 4.35 3.14 5.5H5.17v-1.256C3.364 10.126 2.07 8.46 2.07 6.5 2.07 4.015 4.152 2 6.723 2c1.14 0 2.184.396 2.993 1.053L8.31 4.13c-.45.344-.398.826.11 1.08L15 8.5 13.858.992c-.083-.547-.514-.714-.963-.37l-1.532 1.172A6.825 6.825 0 0 0 6.723 0z",fill:"#fff",id:"turnRight"}),U("path",{d:"M3.637 1.794A6.825 6.825 0 0 1 8.277 0C11.99 0 15 2.91 15 6.5c0 2.316-1.253 4.35-3.14 5.5H9.83v-1.256c1.808-.618 3.103-2.285 3.103-4.244 0-2.485-2.083-4.5-4.654-4.5-1.14 0-2.184.396-2.993 1.053L6.69 4.13c.45.344.398.826-.11 1.08L0 8.5 1.142.992c.083-.547.514-.714.963-.37l1.532 1.172z",fill:"#fff",id:"turnLeft"}),U("path",{d:"M0 0L4 4L0 8Z",fill:"#111",id:"addInput"}),U("path",{d:"M4 0L4 8L0 4Z",fill:"#111",id:"delInput"}),W(X([U("path",{d:"M8 0l2 -2l0 -3l3 0l-4 -5l-4 5l3 0l0 3l-8 0l0 2",fill:"#000",opacity:"0.3"}),ne(-1,-1,U("path",{d:"M8 0l2 -2l0 -3l3 0l-4 -5l-4 5l3 0l0 3l-8 0l0 2",fill:"#fff",opacity:"0.9"}))]),{id:"loopArrow"})]}var je=function(e,t){this.el=U("filter",l(t,{id:e,x0:"-50%",y0:"-50%",width:"200%",height:"200%"}));this.highestId=0};je.prototype.fe=function(e,t,n){var r=e.toLowerCase().replace(/gaussian|osite/,"");var i=[r,"-",++this.highestId].join("");this.el.appendChild($(U("fe"+e,l(t,{result:i})),n||[]));return i};je.prototype.comp=function(e,t,n,r){return this.fe("Composite",l(r,{operator:e,in:t,in2:n}))};je.prototype.subtract=function(e,t){return this.comp("arithmetic",e,t,{k2:+1,k3:-1})};je.prototype.offset=function(e,t,n){return this.fe("Offset",{in:n,dx:e,dy:t})};je.prototype.flood=function(e,t,n){return this.fe("Flood",{in:n,"flood-color":e,"flood-opacity":t})};je.prototype.blur=function(e,t){return this.fe("GaussianBlur",{in:"SourceAlpha",stdDeviation:[e,e].join(" ")})};je.prototype.merge=function(e){this.fe("Merge",{},e.map(function(e){return U("feMergeNode",{in:e})}))};function Ee(e,t){var n=new je(e);var r="SourceAlpha";var i=t?-1:1;var s=n.blur(1,r);n.merge(["SourceGraphic",n.comp("in",n.flood("#fff",.15),n.subtract(r,n.offset(+i,+i,s))),n.comp("in",n.flood("#000",.7),n.subtract(r,n.offset(-i,-i,s)))]);return n.el}function De(e){var t=new je(e);t.merge(["SourceGraphic",t.comp("in",t.flood("#000",.2),"SourceAlpha")]);return t.el}function Ne(e,t,n,r){return W(X([W(r,{class:["sb-"+n,"sb-darker"].join(" ")})]),{width:e,height:t})}function Pe(e){e.draw()}var Fe=function(e,t){this.value=e;this.cls=t||"";this.el=null;this.height=12;this.metrics=null;this.x=0};Fe.prototype.isLabel=true;Fe.prototype.stringify=function(){if(this.value==="<"||this.value===">")return this.value;return this.value.replace(/([<>[\](){}])/g,"\\$1")};Fe.prototype.draw=function(){return this.el};Object.defineProperty(Fe.prototype,"width",{get:function(){return this.metrics.width}});Fe.measuring=function(){var e=t();return e.getContext("2d")}();Fe.metricsCache={};Fe.toMeasure=[];Fe.prototype.measure=function(){var e=this.value;var t=this.cls;this.el=ee(0,10,e,{class:"sb-label "+t});var n=Fe.metricsCache[t];if(!n){n=Fe.metricsCache[t]=Object.create(null)}if(Object.hasOwnProperty.call(n,e)){this.metrics=n[e]}else{var r=/sb-comment-label/.test(this.cls)?"bold 12px Helevetica, Arial, DejaVu Sans, sans-serif":/sb-literal/.test(this.cls)?"normal 9px "+Me:"bold 10px "+Me;this.metrics=n[e]=Fe.measure(e,r)}};Fe.measure=function(e,t){var n=Fe.measuring;n.font=t;var r=n.measureText(e);var i=r.width+.5|0;return{width:i}};var Te=function(e){this.name=e;this.isArrow=e==="loopArrow";var t=Te.icons[e];s(t,"no info for icon "+e);l(t,this)};Te.prototype.isIcon=true;Te.prototype.stringify=function(){return C["@"+this.name]||""};Te.icons={greenFlag:{width:20,height:21,dy:-2},turnLeft:{width:15,height:12,dy:+1},turnRight:{width:15,height:12,dy:+1},loopArrow:{width:14,height:11},addInput:{width:4,height:8},delInput:{width:4,height:8}};Te.prototype.draw=function(){return te("#"+this.name,{width:this.width,height:this.height})};var Ve=function(e,t,n){this.shape=e;this.value=t;this.menu=n||null;this.isRound=e==="number"||e==="number-dropdown";this.isBoolean=e==="boolean";this.isStack=e==="stack";this.isInset=e==="boolean"||e==="stack"||e==="reporter";this.isColor=e==="color";this.hasArrow=e==="dropdown"||e==="number-dropdown";this.isDarker=e==="boolean"||e==="stack"||e==="dropdown";this.isSquare=e==="string"||e==="color"||e==="dropdown";this.hasLabel=!(this.isColor||this.isInset);this.label=this.hasLabel?new Fe(t,["sb-literal-"+this.shape]):null;this.x=0};Ve.prototype.isInput=true;Ve.fromJSON=function(e,t,n){var r={b:"boolean",n:"number",s:"string",d:"number-dropdown",m:"dropdown",c:"color"}[n[1]];if(r==="color"){if(!t&&t!==0)t=parseInt(Math.random()*256*256*256);t=+t;if(t<0)t=4294967295+t+1;var i=t.toString(16);i=i.slice(Math.max(0,i.length-6));while(i.length<6)i="0"+i;if(i[0]===i[1]&&i[2]===i[3]&&i[4]===i[5]){i=i[0]+i[2]+i[4]}t="#"+i}else if(r==="dropdown"){t={_mouse_:"mouse-pointer",_myself_:"myself",_stage_:"Stage",_edge_:"edge",_random_:"random position"}[t]||t;var s=t;t=e.dropdowns[t]||t}else if(r==="number-dropdown"){t=e.dropdowns[t]||t}return new Ve(r,""+t,s)};Ve.prototype.toJSON=function(){if(this.isColor){s(this.value[0]==="#");var e=this.value.slice(1);if(e.length===3)e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2];return parseInt(e,16)}if(this.hasArrow){var t=this.menu||this.value;if(this.shape==="dropdown"){t={"mouse-pointer":"_mouse_",myself:"_myself",Stage:"_stage_",edge:"_edge_","random position":"_random_"}[t]||t}return t}return this.isBoolean?false:this.value};Ve.prototype.stringify=function(){if(this.isColor){s(this.value[0]==="#");return"["+this.value+"]"}var e=(this.value?""+this.value:"").replace(/ v$/," \\v").replace(/([\]\\])/g,"\\$1");if(this.hasArrow)e+=" v";return this.isRound?"("+e+")":this.isSquare?"["+e+"]":this.isBoolean?"<>":this.isStack?"{}":e};Ve.prototype.translate=function(e){if(this.hasArrow){var t=this.menu||this.value;this.value=e.dropdowns[t]||t;this.label=new Fe(this.value,["sb-literal-"+this.shape])}};Ve.prototype.measure=function(){if(this.hasLabel)this.label.measure()};Ve.shapes={string:ie,number:le,"number-dropdown":le,color:ie,dropdown:ie,boolean:he,stack:ve,reporter:le};Ve.prototype.draw=function(e){if(this.hasLabel){var t=this.label.draw();var n=Math.max(14,this.label.width+(this.shape==="string"||this.shape==="number-dropdown"?6:9))}else{var n=this.isInset?30:this.isColor?13:null}if(this.hasArrow)n+=10;this.width=n;var r=this.height=this.isRound||this.isColor?13:14;var i=Ve.shapes[this.shape](n,r);if(this.isColor){W(i,{fill:this.value})}else if(this.isDarker){i=Ne(n,r,e.info.category,i);if(e.info.color){W(i,{fill:e.info.color})}}var s=X([W(i,{class:["sb-input","sb-input-"+this.shape].join(" ")})]);if(this.hasLabel){var o=this.isRound?5:4;s.appendChild(ne(o,0,t))}if(this.hasArrow){var a=this.shape==="dropdown"?5:4;s.appendChild(ne(n-10,a,Y({points:[7,0,3.5,4,0,0],fill:"#000",opacity:"0.6"})))}return s};var ze=function(e,t,n){s(e);this.info=e;this.children=t;this.comment=n||null;var r=this.info.shape;this.isHat=r==="hat"||r==="define-hat";this.hasPuzzle=r==="stack"||r==="hat";this.isFinal=/cap/.test(r);this.isCommand=r==="stack"||r==="cap"||/block/.test(r);this.isOutline=r==="outline";this.isReporter=r==="reporter";this.isBoolean=r==="boolean";this.isRing=r==="ring";this.hasScript=/block/.test(r);this.isElse=r==="celse";this.isEnd=r==="cend";this.x=0;this.width=null;this.height=null;this.firstLine=null;this.innerWidth=null};ze.prototype.isBlock=true;ze.fromJSON=function(e,t,n){var r=t.slice();
var i=r.shift();if(i==="procDef"){var a=r[0];var c=r[1].slice();var h=k(a);var u=h.parts.map(function(e){if(g.test(e)){var t=new Fe(c.shift());return new ze({shape:e[1]==="b"?"boolean":"reporter",category:"custom-arg"},[t])}else{return new Fe(e)}});var f=new ze({shape:"outline"},u);var u=[new Fe(e.define[0]),f];return new ze({shape:"define-hat",category:"custom",selector:"procDef",call:a,names:r[1],language:e},u)}else if(i==="call"){var a=r.shift();var h=l(k(a),{category:"custom",shape:"stack",selector:"call",call:a,language:e});var p=h.parts}else if(i==="readVariable"||i==="contentsOfList:"||i==="getParam"){var d=i==="getParam"&&r.pop()==="b"?"boolean":"reporter";var h={selector:i,shape:d,category:{readVariable:"variables","contentsOfList:":"list",getParam:"custom-arg"}[i],language:e};return new ze(h,[new Fe(r[0])])}else{var h=l(x[i],{language:e});s(h,"unknown selector: "+i);var a=e.commands[h.spec]||a;var p=a?k(a).parts:h.parts}var u=p.map(function(t){if(g.test(t)){var n=r.shift();return(o(n)?ze:Ve).fromJSON(e,n,t)}else if(b.test(t)){return new Te(t.slice(1))}else{return new Fe(t.trim())}});r.forEach(function(t,n){t=t||[];s(o(t));u.push(new Je(t.map(ze.fromJSON.bind(null,e))));if(i==="doIfElse"&&n===0){u.push(new Fe(e.commands["else"]))}});return new ze(h,u)};ze.prototype.toJSON=function(){var e=this.info.selector;var t=[];if(e==="procDef"){var n=this.info.names;var r=this.info.call;var i=k(r);var s=i.inputs.map(function(e){return e==="%n"?1:e==="%b"?false:""});var o=false;return["procDef",r,n,s,o]}if(e==="readVariable"||e==="contentsOfList:"||e==="getParam"){t.push(_(this));if(e==="getParam")t.push(this.isBoolean==="boolean"?"b":"r")}else{for(var a=0;a<this.children.length;a++){var l=this.children[a];if(l.isInput||l.isBlock||l.isScript){t.push(l.toJSON())}}if(e==="call"){return["call",this.info.call].concat(t)}}if(!e)throw"unknown block: "+this.info.hash;return[e].concat(t)};ze.prototype.stringify=function(){var e=null;var t=false;var n=this.children.map(function(n){if(n.isIcon)t=true;if(!e&&!(n.isLabel||n.isIcon))e=n;return n.isScript?"\n"+c(n.stringify())+"\n":n.stringify().trim()+" "}).join("").trim();var r=this.info.language;if(t&&r&&this.info.selector){var i=x[this.info.selector];var s=i.spec;var o=r.nativeAliases[i.spec];if(o){if(g.test(o)&&e){o=o.replace(g,e.stringify())}return o}}if(this.info.shape==="reporter"&&this.info.category==="list"||this.info.category==="custom"&&this.info.shape==="stack"){n+=" :: "+this.info.category}return this.hasScript?n+"\nend":this.info.shape==="reporter"?"("+n+")":this.info.shape==="boolean"?"<"+n+">":n};ze.prototype.translate=function(e,t){var n=this.info.selector;if(!n)return;if(n==="procDef"){s(this.children[0].isLabel);this.children[0]=new Fe(e.define[0]||R.define[0])}var r=x[n];if(!r)return;var i=e.commands[r.spec];if(!i)return;var o=k(i);var l=this.children.filter(function(e){return!e.isLabel&&!e.isIcon});if(!t)l.forEach(function(t){t.translate(e)});this.children=o.parts.map(function(e){var e=e.trim();if(!e)return;return g.test(e)?l.shift():b.test(e)?new Te(e.slice(1)):new Fe(e)}).filter(a);l.forEach(function(e){this.children.push(e)}.bind(this));this.info.language=e;this.info.isRTL=f.indexOf(e.code)>-1};ze.prototype.measure=function(){for(var e=0;e<this.children.length;e++){var t=this.children[e];if(t.measure)t.measure()}if(this.comment)this.comment.measure()};ze.shapes={stack:ve,"c-block":ve,"if-block":ve,celse:ve,cend:ve,cap:be,reporter:le,boolean:he,hat:we,"define-hat":Se,ring:le};ze.prototype.drawSelf=function(e,t,n){if(n.length>1){return xe(e,t,this.isFinal,n,{class:["sb-"+this.info.category,"sb-bevel"].join(" ")})}if(this.info.shape==="outline"){return W(ve(e,t),{class:"sb-outline"})}if(this.isRing){var r=this.children[0];if(r&&(r.isInput||r.isBlock||r.isScript)){var i=r.isScript?"stack":r.isInput?r.shape:r.info.shape;return Ie(e,t,r.y,r.width,r.height,i,{class:["sb-"+this.info.category,"sb-bevel"].join(" ")})}}var o=ze.shapes[this.info.shape];s(o,"no shape func: "+this.info.shape);return o(e,t,{class:["sb-"+this.info.category,"sb-bevel"].join(" ")})};ze.prototype.minDistance=function(e){if(this.isBoolean){return e.isReporter?4+e.height/4|0:e.isLabel?5+e.height/2|0:e.isBoolean||e.shape==="boolean"?5:2+e.height/2|0}if(this.isReporter){return e.isInput&&e.isRound||(e.isReporter||e.isBoolean)&&!e.hasScript?0:e.isLabel?2+e.height/2|0:-2+e.height/2|0}return 0};ze.padding={hat:[15,6,2],"define-hat":[21,8,9],reporter:[3,4,1],boolean:[3,4,2],cap:[6,6,2],"c-block":[3,6,2],"if-block":[3,6,2],ring:[4,4,2],null:[4,6,2]};ze.prototype.draw=function(){var e=this.info.shape==="define-hat";var t=this.children;var n=ze.padding[this.info.shape]||ze.padding[null];var r=n[0],i=n[1],s=n[2];var o=0;var a=function(e){this.y=e;this.width=0;this.height=e?13:16;this.children=[]};var l=0;var c=0;var h=new a(o);function u(e){if(v.length===0){h.height+=r+s}else{h.height+=e?0:+2;h.y-=1}o+=h.height;v.push(h)}if(this.info.isRTL){var f=0;var p=function(){t=t.slice(0,f).concat(t.slice(f,d).reverse()).concat(t.slice(d))}.bind(this);for(var d=0;d<t.length;d++){if(t[d].isScript){p();f=d+1}}if(f<d){p()}}var v=[];for(var d=0;d<t.length;d++){var g=t[d];g.el=g.draw(this);if(g.isScript&&this.isCommand){this.hasScript=true;u();g.y=o;v.push(g);c=Math.max(c,Math.max(1,g.width));g.height=Math.max(12,g.height)+3;o+=g.height;h=new a(o)}else if(g.isArrow){h.children.push(g)}else{var m=d>0?30:0;var b=this.isCommand?0:this.minDistance(g);var w=this.isCommand?g.isBlock||g.isInput?m:0:b;if(w&&!v.length&&h.width<w-i){h.width=w-i}g.x=h.width;h.width+=g.width;l=Math.max(l,h.width+Math.max(0,b-i));h.width+=4;if(!g.isLabel){h.height=Math.max(h.height,g.height)}h.children.push(g)}}u(true);l=Math.max(l+i*2,this.isHat||this.hasScript?83:this.isCommand||this.isOutline||this.isRing?39:20);this.height=o;this.width=c?Math.max(l,15+c):l;if(e){var y=Math.min(26,3.5+.13*l|0)-18;this.height+=y;r+=2*y}this.firstLine=v[0];this.innerWidth=l;var k=[];for(var d=0;d<v.length;d++){var h=v[d];if(h.isScript){k.push(ne(15,h.y,h.el));continue}var L=h.height;for(var S=0;S<h.children.length;S++){var g=h.children[S];if(g.isArrow){k.push(ne(l-15,this.height-3,g.el));continue}var o=r+(L-g.height-r-s)/2-1;if(e&&g.isLabel){o+=3}else if(g.isIcon){o+=g.dy|0}if(this.isRing){g.y=h.y+o|0;if(g.isInset){continue}}k.push(ne(i+g.x,h.y+o|0,g.el))}}var x=this.drawSelf(l,this.height,v);k.splice(0,0,x);if(this.info.color){W(x,{fill:this.info.color})}return X(k)};var _e=function(e,t){this.label=new Fe(e,["sb-comment-label"]);this.width=null;this.hasBlock=t};_e.prototype.isComment=true;_e.lineLength=12;_e.prototype.height=20;_e.prototype.stringify=function(){return"// "+this.label.value};_e.prototype.measure=function(){this.label.measure()};_e.prototype.draw=function(){var e=this.label.draw();this.width=this.label.width+16;return X([Ce(this.hasBlock?_e.lineLength:0,6),Oe(this.width,this.height,{class:"sb-comment"}),ne(8,4,e)])};var Je=function(e){this.blocks=e;this.isEmpty=!e.length;this.isFinal=!this.isEmpty&&e[e.length-1].isFinal;this.y=0};Je.prototype.isScript=true;Je.fromJSON=function(e,t){return new Je(t.map(ze.fromJSON.bind(null,e)))};Je.prototype.toJSON=function(){if(this.blocks[0]&&this.blocks[0].isComment)return;return this.blocks.map(function(e){return e.toJSON()})};Je.prototype.stringify=function(){return this.blocks.map(function(e){var t=e.stringify();if(e.comment)t+=" "+e.comment.stringify();return t}).join("\n")};Je.prototype.translate=function(e){this.blocks.forEach(function(t){t.translate(e)})};Je.prototype.measure=function(){for(var e=0;e<this.blocks.length;e++){this.blocks[e].measure()}};Je.prototype.draw=function(e){var t=[];var n=0;this.width=0;for(var r=0;r<this.blocks.length;r++){var i=this.blocks[r];t.push(ne(e?0:2,n,i.draw()));n+=i.height;this.width=Math.max(this.width,i.width);var s=i.comment;if(s){var o=i.firstLine;var a=i.innerWidth+2+_e.lineLength;var l=n-i.height+o.height/2;var c=s.draw();t.push(ne(a,l-s.height/2,c));this.width=Math.max(this.width,a+s.width)}}this.height=n;if(!e&&!this.isFinal){this.height+=3}return X(t)};var Ze=function(e){this.scripts=e;this.width=null;this.height=null;this.el=null;this.defs=null};Ze.fromJSON=function(e,t){var t=t||R;var n=e.scripts.map(function(e){var n=Je.fromJSON(t,e[2]);n.x=e[0];n.y=e[1];return n});return new Ze(n)};Ze.prototype.toJSON=function(){var e=this.scripts.map(function(e){var t=e.toJSON();if(!t)return;return[10,e.y+10,t]}).filter(a);return{scripts:e}};Ze.prototype.stringify=function(){return this.scripts.map(function(e){return e.stringify()}).join("\n\n")};Ze.prototype.translate=function(e){this.scripts.forEach(function(t){t.translate(e)})};Ze.prototype.measure=function(){this.scripts.forEach(function(e){e.measure()})};Ze.prototype.render=function(e){this.measure();var t=0;var n=0;var r=[];for(var i=0;i<this.scripts.length;i++){var s=this.scripts[i];if(n)n+=10;s.y=n;r.push(ne(0,n,s.draw()));n+=s.height;t=Math.max(t,s.width+4)}this.width=t;this.height=n;var o=q(t,n);o.appendChild(this.defs=$(U("defs"),[Ee("bevelFilter",false),Ee("inputBevelFilter",true),De("inputDarkFilter")].concat(Re())));o.appendChild(X(r));this.el=o;e(o)};Ze.prototype.exportSVGString=function(){s(this.el,"call draw() first");var e=Be();this.defs.appendChild(e);var t=(new r).serializeToString(this.el);this.defs.removeChild(e);return t};Ze.prototype.exportSVG=function(){var e=this.exportSVGString();return"data:image/svg+xml;utf8,"+e.replace(/[#]/g,encodeURIComponent)};Ze.prototype.exportPNG=function(e){var n=t();n.width=this.width;n.height=this.height;var r=n.getContext("2d");var i=new Image;i.src=this.exportSVG();i.onload=function(){r.drawImage(i,0,0);if(URL&&URL.createObjectURL&&Blob&&n.toBlob){var t=n.toBlob(function(t){e(URL.createObjectURL(t))},"image/png")}else{e(n.toDataURL("image/png"))}}};function Ge(e,t){return e.render(t)}function He(e,t){var t=l({inline:false},t);var r=e.innerHTML.replace(/<br>\s?|\n|\r\n|\r/gi,"\n");var i=n.createElement("pre");i.innerHTML=r;var s=i.textContent;if(t.inline){s=s.replace("\n","")}return s}function Ue(e,t,r,i){if(i.inline){var s=n.createElement("span");var o="scratchblocks scratchblocks-inline";if(r[0]&&!r[0].isEmpty){o+=" scratchblocks-inline-"+r[0].blocks[0].shape}s.className=o;s.style.display="inline-block";s.style.verticalAlign="middle"}else{var s=n.createElement("div");s.className="scratchblocks"}s.appendChild(t);e.innerHTML="";e.appendChild(s)}var Qe=function(e,t){var e=e||"pre.blocks";var t=l({inline:false,languages:["en"],read:He,parse:Z,render:Ge,replace:Ue},t);var r=[].slice.apply(n.querySelectorAll(e));r.forEach(function(e){var n=t.read(e,t);var r=t.parse(n,t);t.render(r,function(n){t.replace(e,n,r,t)})})};var We=function(e,t){var n=Z(e,t);n.render(function(){});return n.exportSVGString()};return{allLanguages:A,loadLanguages:B,fromJSON:Ze.fromJSON,toJSON:function(e){return e.toJSON()},stringify:function(e){return e.stringify()},Label:Fe,Icon:Te,Input:Ve,Block:ze,Comment:_e,Script:Je,Document:Ze,read:He,parse:Z,replace:Ue,renderMatching:Qe,renderSVGString:We,makeStyle:Be}});
